╔═══════════════════════════════════════════════════════════════════════════════════╗
║                    AI ANALYST COMPONENT VISUAL MAP                                 ║
║              "Exactly Where The AI Analyst is Coded in AngelAI"                    ║
╚═══════════════════════════════════════════════════════════════════════════════════╝

═══════════════════════════════════════════════════════════════════════════════════════
                         FRONTEND LAYER (React Components)
═══════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│  FILE: components/AnalystScreeningEditor.tsx (432 lines)                           │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │ LINE 233-236: Header                                                        │  │
│  │ "Analyst Screening (7 criteria)"                                            │  │
│  │ "Score each criterion 1–5 and save your analysis memo + recommendation"     │  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  ┌──────────────────────────────┐     ┌──────────────────────────────────────────┐│
│  │ LINE 239-248:                │     │ LINE 250-261:                            ││
│  │ "AI Screen Pitch Deck"       │     │ "AI Recommender" ⭐ PRIMARY BUTTON       ││
│  │ (Calls: ai-screen-deal)      │     │ (Calls: ai-recommend-deal)               ││
│  │                              │     │ Generates the 65/100 SCORE               ││
│  └──────────────────────────────┘     └──────────────────────────────────────────┘│
│           │                                      │                                  │
│           ▼                                      ▼                                  │
│    Returns: Scores                   Returns: Score (0-100)                        │
│    for each criterion                Recommendation text                           │
│                                      Detailed rationale                            │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │ LINE 267-337: AI RECOMMENDATION METER                                       │  │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐│  │
│  │ │ AI Recommendation                                               65/100 ││  │
│  │ ├─────────────────────────────────────────────────────────────────────────┤│  │
│  │ │ Progress Bar: [████████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]   ││  │
│  │ │                                                                        ││  │
│  │ │ <40: Reject | 40-59: More Info | 60-79: Deep Dive | 80+: Recommend  ││  │
│  │ │                              ▲ CURRENTLY HERE                         ││  │
│  │ │                                                                        ││  │
│  │ │ Recommendation: "Proceed with deep dive..."                           ││  │
│  │ │ Rationale: [Click to expand detailed analysis...]                    ││  │
│  │ └─────────────────────────────────────────────────────────────────────────┘│  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │ LINE 344-390: 7 SCREENING CRITERIA (Loop for each)                         │  │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐│  │
│  │ │ Market Opportunity                                     Weight: 1       ││  │
│  │ │ [Slider: 1]────●─────[5]                                Score: 3      ││  │
│  │ │ Analysis Notes: (textarea for detailed explanation)                   ││  │
│  │ └─────────────────────────────────────────────────────────────────────────┘│  │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐│  │
│  │ │ Team Quality                                           Weight: 1.5     ││  │
│  │ │ [Slider: 1]────●─────[5]                                Score: 4      ││  │
│  │ │ Analysis Notes: (filled by AI or analyst)                            ││  │
│  │ └─────────────────────────────────────────────────────────────────────────┘│  │
│  │ [... 5 more criteria ...]                                                 │  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │ LINE 392-425: OVERALL SCORE & DECISION                                     │  │
│  │ Overall Score (Weighted): 3.4                                              │  │
│  │ Decision: [Dropdown: Recommend | Needs Info | Not Recommend]              │  │
│  │ Executive Summary Memo: [Large textarea]                                   │  │
│  │ [Save Analysis Button]                                                     │  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                                                                     │
│  FILE: components/AnalystYCFlags.tsx (387 lines)                                   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │ LINE 174-177: Header                                                        │  │
│  │ "YC-Style Flags (Analyst)"                                                  │  │
│  │ "Mark red flags (warnings) and green flags (strengths) in your analysis"   │  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  ┌──────────────────────────────────────────────────────────────────────────────┐ │
│  │ LINE 179-189: "AI Detect Flags" Button                                      │ │
│  │ (Calls: ai-detect-flags)                                                   │ │
│  │ Triggers AI to detect 3-5 green + 3-5 red flags                            │ │
│  └──────────────────────────────────────────────────────────────────────────────┘ │
│              │                                                                      │
│              ▼                                                                      │
│       Returns: green_flags[] & red_flags[]                                         │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │ LINE 195-256: GREEN FLAGS SECTION                                           │  │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐│  │
│  │ │ ✓ Green Flags (2)                          + Add from catalog          ││  │
│  │ │                                                                        ││  │
│  │ │ ┌────────────────────────────────────────────────────────────────────┐││  │
│  │ │ │ Exceptional founding team [Remove]                               │││  │
│  │ │ │ Supporting evidence: Founded 2 startups before, $10M ARR growth  │││  │
│  │ │ └────────────────────────────────────────────────────────────────────┘││  │
│  │ │                                                                        ││  │
│  │ │ ┌────────────────────────────────────────────────────────────────────┐││  │
│  │ │ │ Strong product-market fit [Remove]                               │││  │
│  │ │ │ Supporting evidence: 50% MoM growth, 80% retention rate...      │││  │
│  │ │ └────────────────────────────────────────────────────────────────────┘││  │
│  │ └─────────────────────────────────────────────────────────────────────────┘│  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │ LINE 259-321: RED FLAGS SECTION                                             │  │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐│  │
│  │ │ ! Red Flags (1)                            + Add from catalog          ││  │
│  │ │                                                                        ││  │
│  │ │ ┌────────────────────────────────────────────────────────────────────┐││  │
│  │ │ │ Limited traction [Remove]                                         │││  │
│  │ │ │ Supporting evidence: Only 100 users, no enterprise customers...  │││  │
│  │ │ └────────────────────────────────────────────────────────────────────┘││  │
│  │ └─────────────────────────────────────────────────────────────────────────┘│  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐  │
│  │ LINE 325-377: FLAGS CATALOG MODAL                                           │  │
│  │ ┌─────────────────────────────────────────────────────────────────────────┐│  │
│  │ │ Standard Green Flags                                               [X] ││  │
│  │ │ [all] [team] [traction] [market] [product] [business model]           ││  │
│  │ │                                                                        ││  │
│  │ │ ☐ Exceptional founder(s)                                              ││  │
│  │ │   Prior exits, deep domain expertise, technical excellence            ││  │
│  │ │                                                                        ││  │
│  │ │ ☐ Strong technical team                                               ││  │
│  │ │   Engineers from top companies, proven track record                   ││  │
│  │ │                                                                        ││  │
│  │ │ ☐ Strong product-market fit                                           ││  │
│  │ │   High engagement, low churn, organic growth                          ││  │
│  │ │   [... 20+ more predefined flags ...]                                ││  │
│  │ └─────────────────────────────────────────────────────────────────────────┘│  │
│  └─────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  LINE 380-382: Save Button                                                        │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                        BACKEND EDGE FUNCTIONS LAYER
═══════════════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────────────┐
│ FUNCTION 1: AI Screen Pitch Deck                                                    │
│ FILE: supabase/functions/ai-screen-deal/index.ts (310 lines)                       │
│                                                                                     │
│ Triggered By: "AI Screen Pitch Deck" button (AnalystScreeningEditor.tsx:241)       │
│                                                                                     │
│ Process:                                                                             │
│ 1. Download PDF from deal-docs bucket (Line 65-67)                                 │
│ 2. Convert to base64 (Line 76-85)                                                  │
│ 3. Fetch 7 screening criteria from DB (Line 87-92)                                 │
│ 4. Build prompt with criteria definitions (Line 108-146)                           │
│ 5. Call Claude Haiku API (Line 154-189)                                            │
│    model: "claude-haiku-4-5-20251001"                                              │
│ 6. Parse JSON response (Line 231-250)                                              │
│ 7. Map scores to criteria IDs (Line 253-280)                                       │
│ 8. Calculate weighted overall score (Line 285-287)                                 │
│ 9. Return to frontend (Line 289-296)                                               │
│                                                                                     │
│ Return Format:                                                                       │
│ {                                                                                    │
│   "ok": true,                                                                       │
│   "overall_score": 3.5,                                                             │
│   "criteria_scores": [                                                              │
│     {"criterion_id": "uuid", "score": 4, "note": "..."},                           │
│     // ... 7 total                                                                  │
│   ],                                                                                 │
│   "overall_assessment": "Summary"                                                   │
│ }                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│ FUNCTION 2: AI Recommend Deal ⭐ PRIMARY - GENERATES THE 0-100 SCORE                │
│ FILE: supabase/functions/ai-recommend-deal/index.ts (365 lines)                    │
│                                                                                     │
│ Triggered By: "AI Recommender" button (AnalystScreeningEditor.tsx:252)             │
│                                                                                     │
│ Process:                                                                             │
│ 1. Fetch deal details (Line 22-37)                                                 │
│ 2. Fetch manager screening scores (Line 48-55)                                     │
│ 3. Fetch manager review (Line 58-62)                                               │
│ 4. Fetch manager flags (Line 65-69)                                                │
│ 5. Fetch ALL analyst reviews (Line 72-81) ← Multiple analysts                      │
│ 6. Fetch ALL analyst scores (Line 84-92) ← All their criterion scores              │
│ 7. Fetch ALL analyst flags (Line 95-98) ← Their green/red flags                    │
│ 8. Build comprehensive analysis prompt (Line 101-109, 193-342)                     │
│    - Manager's analysis details                                                     │
│    - Each analyst's analysis details                                                │
│    - All flags from manager and analysts                                            │
│ 9. Call Claude Sonnet API (Line 117-132)                                           │
│    model: "claude-sonnet-4-20250514"  ← More powerful model for synthesis           │
│ 10. Parse response to extract SCORE, RECOMMENDATION, RATIONALE (Line 144, 343-357)│
│ 11. Store in ai_recommendations table (Line 147-167)                               │
│ 12. Return to frontend (Line 174-181)                                              │
│                                                                                     │
│ Return Format:                                                                       │
│ {                                                                                    │
│   "success": true,                                                                  │
│   "score": 65,                    ← THIS IS THE 0-100 SCORE                        │
│   "recommendation": "Proceed with deep dive...",                                   │
│   "rationale": "Detailed 200-300 word explanation..."                              │
│ }                                                                                    │
│                                                                                     │
│ Scoring Scale:                                                                       │
│ 0-39:   Strong Reject                                                               │
│ 40-59:  Reject or Request More Information                                         │
│ 60-79:  Deep Dive Required                  ← 65 falls here (ORANGE)               │
│ 80-100: Recommend to IC                                                             │
└─────────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────────┐
│ FUNCTION 3: AI Detect Flags                                                        │
│ FILE: supabase/functions/ai-detect-flags/index.ts (211 lines)                      │
│                                                                                     │
│ Triggered By: "AI Detect Flags" button (AnalystYCFlags.tsx:181)                    │
│                                                                                     │
│ Process:                                                                             │
│ 1. Fetch deal with startup details (Line 22-35)                                    │
│ 2. Download pitch deck if available (Line 45-70, optional)                         │
│ 3. Build YC-analyst prompt (Line 73-118)                                           │
│    Instructions: "Identify 3-5 green + 3-5 red flags"                              │
│ 4. Call Claude Haiku API (Line 159-167)                                            │
│    model: "claude-haiku-4-5-20251001"                                              │
│    Send PDF if available, otherwise just text                                      │
│ 5. Parse JSON response (Line 181-193)                                              │
│ 6. Return to frontend (Line 195-201)                                               │
│                                                                                     │
│ Return Format:                                                                       │
│ {                                                                                    │
│   "ok": true,                                                                       │
│   "green_flags": [                                                                  │
│     {"flag": "Exceptional team", "note": "Founded 2 exits..."},                   │
│     {"flag": "Strong PMF", "note": "50% MoM growth..."}                            │
│   ],                                                                                 │
│   "red_flags": [                                                                    │
│     {"flag": "Limited traction", "note": "100 users only..."},                     │
│     {"flag": "Weak unit economics", "note": "LTV/CAC < 2..."}                     │
│   ]                                                                                  │
│ }                                                                                    │
└─────────────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════════════
                            DATABASE LAYER
═══════════════════════════════════════════════════════════════════════════════════════

SCHEMA FILE 1: supabase/migrations/013_dealflow_analyst.sql
├─ Table: analyst_screening_scores (7 criteria scores from analyst)
│  └─ Columns: deal_id, analyst_user_id, criterion_id, score (1-5), note
│
├─ Table: analyst_screening_reviews (overall analyst review)
│  └─ Columns: deal_id, analyst_user_id, overall_score, decision, summary_memo
│
├─ Table: analyst_deal_flags (green + red flags from analyst)
│  └─ Columns: deal_id, analyst_user_id, green_flags (JSONB), red_flags (JSONB)
│
└─ View: deal_all_analyses (combines manager + analyst analyses)

SCHEMA FILE 2: supabase/migrations/002_yc_flags.sql
├─ Table: deal_flags (manager's green/red flags)
│  └─ Columns: deal_id, manager_user_id, green_flags (JSONB), red_flags (JSONB)
│
├─ Table: yc_flags_catalog (reference: 30+ predefined YC flags)
│  ├─ Columns: flag_type ('green'|'red'), category, flag_text, description
│  └─ Categories: Team, Traction, Market, Product, Business Model, Deal Terms
│
└─ Table: ai_recommendations (stores 0-100 score + recommendation)
   └─ Columns: deal_id, score (0-100), recommendation_text, rationale, analysis_data


═══════════════════════════════════════════════════════════════════════════════════════
                            DATA FLOW
═══════════════════════════════════════════════════════════════════════════════════════

USER CLICKS "AI Recommender"
│
├─→ Frontend: AnalystScreeningEditor.tsx:252
│  └─→ fetch POST /functions/v1/ai-recommend-deal
│
├─→ Backend: ai-recommend-deal/index.ts:4-191
│  ├─→ Query deals table (deal details)
│  ├─→ Query screening_scores table (manager's scores)
│  ├─→ Query analyst_screening_reviews table (analyst reviews)
│  ├─→ Query analyst_screening_scores table (analyst scores for each criterion)
│  ├─→ Query analyst_deal_flags table (analyst's flags)
│  ├─→ Query deal_flags table (manager's flags)
│  │
│  ├─→ Build comprehensive prompt with ALL data
│  │
│  ├─→ Call Claude Sonnet API
│  │   Input: Full context including manager + analyst perspectives
│  │   Output: "SCORE: 65\nRECOMMENDATION: ...\nRATIONALE: ..."
│  │
│  ├─→ Parse response (ai-recommend-deal/index.ts:343-357)
│  │   Extract: score = 65, recommendation text, rationale
│  │
│  ├─→ INSERT INTO ai_recommendations (Line 147-167)
│  │   Store: score, recommendation_text, rationale, analysis_data JSON
│  │
│  └─→ Return to Frontend: { success: true, score: 65, ... }
│
└─→ Frontend: Display in AI Recommendation Meter (AnalystScreeningEditor.tsx:267-337)
   └─→ Show: 65/100 with orange color + recommendation text + expandable rationale


═══════════════════════════════════════════════════════════════════════════════════════
                    QUICK COPY-PASTE FILE PATHS
═══════════════════════════════════════════════════════════════════════════════════════

FRONTEND COMPONENTS:
C:\Users\spiri\angel_ai\components\AnalystScreeningEditor.tsx
C:\Users\spiri\angel_ai\components\AnalystYCFlags.tsx
C:\Users\spiri\angel_ai\components\AnalystAnalysesView.tsx

BACKEND FUNCTIONS:
C:\Users\spiri\angel_ai\supabase\functions\ai-screen-deal\index.ts
C:\Users\spiri\angel_ai\supabase\functions\ai-recommend-deal\index.ts
C:\Users\spiri\angel_ai\supabase\functions\ai-detect-flags\index.ts

DATABASE MIGRATIONS:
C:\Users\spiri\angel_ai\supabase\migrations\013_dealflow_analyst.sql
C:\Users\spiri\angel_ai\supabase\migrations\002_yc_flags.sql


═══════════════════════════════════════════════════════════════════════════════════════
                        KEY LINE NUMBERS
═══════════════════════════════════════════════════════════════════════════════════════

AnalystScreeningEditor.tsx:
  Line 233:     "Analyst Screening (7 criteria)" header
  Line 239:     "AI Screen Pitch Deck" button
  Line 250:     "AI Recommender" button (MAIN)
  Line 267:     AI Recommendation Meter (shows 65/100)
  Line 273:     Score color coding (green/orange/yellow/red)
  Line 299:     Score bands (<40, 40-59, 60-79, 80+)
  Line 344:     7 criteria loop (scoring sliders)
  Line 71:      computeOverall() function (weighted average)

AnalystYCFlags.tsx:
  Line 174:     "YC-Style Flags (Analyst)" header
  Line 179:     "AI Detect Flags" button
  Line 195:     Green Flags section
  Line 259:     Red Flags section
  Line 325:     Flags Catalog modal

ai-recommend-deal/index.ts:
  Line 125:     Claude Sonnet model specification
  Line 144:     parseRecommendation() call
  Line 319:     Scoring scale definition
  Line 343:     parseRecommendation() function (extracts SCORE, RECOMMENDATION, RATIONALE)

ai-screen-deal/index.ts:
  Line 160:     Claude Haiku model specification

ai-detect-flags/index.ts:
  Line 131:     Claude Haiku model specification


═══════════════════════════════════════════════════════════════════════════════════════
